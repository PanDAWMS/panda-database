-- Generated by Ora2Pg, the Oracle database Schema converter, version 21.1
-- Copyright 2000-2020 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:PDBR

SET client_encoding TO 'UTF8';

SET search_path = doma_pandabigmon,public;
\set ON_ERROR_STOP ON

SET check_function_bodies = false;

CREATE OR REPLACE VIEW getrwwithpriojedi3days (jeditaskid, taskname, datasetid, modificationtime, cloud, corecount, processingtype, ramcount, ramunit, nrem, prodsourcelabel, walltime, workinggroup, fsize, startevent, endevent, nevents, username) AS SELECT t4.jediTaskID, t4.taskname, t4.datasetID, t4.modificationTime, t4.cloud, t4.corecount, t4.processingtype,
t4.ramcount, t4.ramunit, t4.nRem, t4.prodsourcelabel, t4.walltime, t4.workinggroup, t5.fsize, t5.startEvent,
t5.endEvent, t5.nEvents, t4.username
FROM (
SELECT tabT.jediTaskID, tabT.MODIFICATIONTIME, tabT.cloud, tabT.CORECOUNT, tabT.processingtype,
tabT.ramcount, tabT.ramunit, tabT.PRODSOURCELABEL, tabT.taskname, tabT.WORKINGGROUP,
tabD.datasetID, nFiles-nFilesFinished-nFilesFailed as nRem, walltime, tabT.username
FROM DOMA_PANDA.JEDI_Tasks tabT, DOMA_PANDA.JEDI_Datasets tabD,
DOMA_PANDA.JEDI_AUX_Status_MinTaskID tabA
WHERE (tabT.status=tabA.status AND tabT.jediTaskID>=tabA.min_jediTaskID
AND tabT.jediTaskID=tabD.jediTaskID AND coalesce(masterID::text, '') = ''
AND (nFiles-nFilesFinished-nFilesFailed)>0 AND (tabT.MODIFICATIONTIME >
LOCALTIMESTAMP - interval '3 days') AND tabD.type IN ('input','pseudo_input') AND
tabT.status IN ('ready','scouting', 'running', 'pending') AND (tabT.cloud IS NOT NULL AND tabT.cloud::text <> '')
))t4
LEFT JOIN(
SELECT fsize, startEvent, endEvent, nEvents, DATASETID, jediTaskID,
ROW_NUMBER() OVER (PARTITION BY DATASETID, jediTaskID ORDER BY FSIZE DESC) as RANK FROM
DOMA_PANDA.JEDI_Dataset_Contents tabC
) t5
ON t4.jediTaskID=t5.jediTaskID AND t4.datasetID=t5.DATASETID AND t5.RANK
= 1;

ALTER VIEW getrwwithpriojedi3days OWNER TO panda;
CREATE OR REPLACE VIEW jedi_tasks_ordered (jeditaskid, taskname, status, username, creationdate, modificationtime, reqid, oldstatus, cloud, site, starttime, endtime, frozentime, prodsourcelabel, workinggroup, vo, corecount, tasktype, processingtype, taskpriority, currentpriority, architecture, transuses, transhome, transpath, lockedby, lockedtime, termcondition, splitrule, walltime, walltimeunit, outdiskcount, outdiskunit, workdiskcount, workdiskunit, ramcount, ramunit, iointensity, iointensityunit, workqueue_id, progress, failurerate, errordialog, countrygroup, parent_tid, eventservice, ticketid, ticketsystemtype, statechangetime, superstatus, campaign, mergeramcount, mergeramunit, mergewalltime, mergewalltimeunit, throttledtime, numthrottled, mergecorecount, goal, assessmenttime, cputime, cputimeunit, cpuefficiency, basewalltime, amiflag_old, amiflag, nucleus, baseramcount, ttcrequested, ttcpredicted, ttcpredictiondate, rescuetime, requesttype, gshare, resource_type, usejumbo, diskio, diskiounit, container_name, attemptnr) AS SELECT JEDITASKID,TASKNAME,STATUS,USERNAME,CREATIONDATE,
MODIFICATIONTIME,REQID,OLDSTATUS,CLOUD,SITE,STARTTIME,ENDTIME,
FROZENTIME,PRODSOURCELABEL,WORKINGGROUP,VO,CORECOUNT,TASKTYPE,
PROCESSINGTYPE,TASKPRIORITY,CURRENTPRIORITY,ARCHITECTURE,TRANSUSES,
TRANSHOME,TRANSPATH,LOCKEDBY,LOCKEDTIME,TERMCONDITION,SPLITRULE
,WALLTIME,WALLTIMEUNIT,OUTDISKCOUNT,OUTDISKUNIT,WORKDISKCOUNT,
WORKDISKUNIT,RAMCOUNT,RAMUNIT,IOINTENSITY,IOINTENSITYUNIT,WORKQUEUE_ID,
PROGRESS,FAILURERATE,ERRORDIALOG,COUNTRYGROUP,PARENT_TID,EVENTSERVICE,
TICKETID,TICKETSYSTEMTYPE,STATECHANGETIME,SUPERSTATUS,CAMPAIGN,
MERGERAMCOUNT,MERGERAMUNIT,MERGEWALLTIME,MERGEWALLTIMEUNIT,
THROTTLEDTIME,NUMTHROTTLED,MERGECORECOUNT,GOAL,ASSESSMENTTIME,
CPUTIME,CPUTIMEUNIT,CPUEFFICIENCY,BASEWALLTIME,AMIFLAG_OLD,AMIFLAG,
NUCLEUS,BASERAMCOUNT,TTCREQUESTED,TTCPREDICTED,TTCPREDICTIONDATE,
RESCUETIME,REQUESTTYPE,GSHARE,RESOURCE_TYPE, USEJUMBO, DISKIO,
DISKIOUNIT,CONTAINER_NAME,ATTEMPTNR
FROM DOMA_PANDA.JEDI_TASKS 
ORDER BY JEDITASKID DESC;

ALTER VIEW jedi_tasks_ordered OWNER TO panda;
CREATE OR REPLACE VIEW requests_view (server) AS SELECT server
   FROM doma_pandabigmon.all_requests_daily;

ALTER VIEW requests_view OWNER TO panda;
CREATE OR REPLACE VIEW geteventsfortask (jeditaskid, totevrem, totev, modificationtime) AS SELECT JEDITASKID,
ROUND(SUM(
CASE WHEN NFILESUSED > 0 THEN (NFILES-NFILESFINISHED)/NFILES*NEVENTS
     ELSE 0
END
)) as TOTEVREM, SUM(NEVENTS) as TOTEV, MAX(MODIFICATIONTIME) as MODIFICATIONTIME FROM DOMA_PANDA.JEDI_DATASETS WHERE (TYPE IN ('input','pseudo_input')) AND coalesce(MASTERID::text, '') = '' GROUP BY JEDITASKID;

ALTER VIEW geteventsfortask OWNER TO panda;
CREATE OR REPLACE VIEW combined_wait_act_def_arch4 (partid, dbmodtime, pandaid, jobdefinitionid, schedulerid, pilotid, creationtime, creationhost, modificationtime, modificationhost, atlasrelease, transformation, homepackage, prodserieslabel, prodsourcelabel, produserid, assignedpriority, currentpriority, attemptnr, maxattempt, jobstatus, jobname, maxcpucount, maxcpuunit, maxdiskcount, maxdiskunit, ipconnectivity, minramcount, minramunit, starttime, endtime, cpuconsumptiontime, cpuconsumptionunit, commandtopilot, transexitcode, piloterrorcode, piloterrordiag, exeerrorcode, exeerrordiag, superrorcode, superrordiag, ddmerrorcode, brokerageerrorcode, brokerageerrordiag, jobdispatchererrorcode, jobdispatchererrordiag, taskbuffererrorcode, taskbuffererrordiag, computingsite, computingelement, jobparameters, metadata, proddblock, dispatchdblock, destinationdblock, destinationse, nevents, grid, cloud, cpuconversion, sourcesite, destinationsite, transfertype, taskid, cmtconfig, statechangetime, proddbupdatetime, lockedby, relocationflag, jobexecutionid, vo, pilottiming, workinggroup, processingtype, produsername, ninputfiles, countrygroup, batchid, parentid, specialhandling, jobsetid, corecount, ninputdatafiles, inputfiletype, inputfileproject, inputfilebytes, noutputdatafiles, outputfilebytes, jobmetrics, workqueue_id, jeditaskid, jobsubstatus, actualcorecount, reqid, maxrss, maxvmem, maxswap, maxpss, avgrss, avgvmem, avgswap, avgpss, maxwalltime, nucleus, es, taskname, tasktype, isarchive, eventservice, username) AS SELECT PARTID, DBMODTIME , t1.PANDAID,t1.JOBDEFINITIONID,t1.SCHEDULERID,t1.PILOTID,t1.CREATIONTIME,t1.CREATIONHOST,t1.MODIFICATIONTIME,t1.MODIFICATIONHOST,t1.ATLASRELEASE,t1.TRANSFORMATION,t1.HOMEPACKAGE,t1.PRODSERIESLABEL,t1.PRODSOURCELABEL,t1.PRODUSERID,t1.ASSIGNEDPRIORITY,t1.CURRENTPRIORITY,t1.ATTEMPTNR,t1.MAXATTEMPT,t1.JOBSTATUS,t1.JOBNAME,t1.MAXCPUCOUNT,t1.MAXCPUUNIT,t1.MAXDISKCOUNT,t1.MAXDISKUNIT,t1.IPCONNECTIVITY,t1.MINRAMCOUNT,t1.MINRAMUNIT,t1.STARTTIME,t1.ENDTIME,t1.CPUCONSUMPTIONTIME,t1.CPUCONSUMPTIONUNIT,t1.COMMANDTOPILOT,t1.TRANSEXITCODE,t1.PILOTERRORCODE,t1.PILOTERRORDIAG,t1.EXEERRORCODE,t1.EXEERRORDIAG,t1.SUPERRORCODE,t1.SUPERRORDIAG,t1.DDMERRORCODE,t1.BROKERAGEERRORCODE,t1.BROKERAGEERRORDIAG,t1.JOBDISPATCHERERRORCODE,t1.JOBDISPATCHERERRORDIAG,t1.TASKBUFFERERRORCODE,t1.TASKBUFFERERRORDIAG,t1.COMPUTINGSITE,t1.COMPUTINGELEMENT,t1.JOBPARAMETERS,t1.METADATA,t1.PRODDBLOCK,t1.DISPATCHDBLOCK,t1.DESTINATIONDBLOCK,t1.DESTINATIONSE,t1.NEVENTS,t1.GRID,t1.CLOUD,t1.CPUCONVERSION,t1.SOURCESITE,t1.DESTINATIONSITE,t1.TRANSFERTYPE,t1.TASKID,t1.CMTCONFIG,t1.STATECHANGETIME,t1.PRODDBUPDATETIME,t1.LOCKEDBY,t1.RELOCATIONFLAG,t1.JOBEXECUTIONID,t1.VO,t1.PILOTTIMING,t1.WORKINGGROUP,t1.PROCESSINGTYPE,t1.PRODUSERNAME,t1.NINPUTFILES,t1.COUNTRYGROUP,t1.BATCHID,t1.PARENTID,t1.SPECIALHANDLING,t1.JOBSETID,t1.CORECOUNT,t1.NINPUTDATAFILES,t1.INPUTFILETYPE,t1.INPUTFILEPROJECT,t1.INPUTFILEBYTES,t1.NOUTPUTDATAFILES,t1.OUTPUTFILEBYTES,t1.JOBMETRICS,t1.WORKQUEUE_ID,t1.JEDITASKID,t1.JOBSUBSTATUS,t1.ACTUALCORECOUNT,t1.REQID,t1.MAXRSS,t1.MAXVMEM,t1.MAXSWAP,t1.MAXPSS,t1.AVGRSS,t1.AVGVMEM,t1.AVGSWAP,t1.AVGPSS,t1.MAXWALLTIME, t1.NUCLEUS, t1.ES, t2.TASKNAME, t2.TASKTYPE, t1.isarchive, t1.eventservice, t2.USERNAME FROM (
SELECT
CAST( ORA_HASH(PANDAID, 20) as numeric) AS  PARTID,
ORA_ROWSCN AS DBMODTIME,
"PANDAID","JOBDEFINITIONID","SCHEDULERID","PILOTID","CREATIONTIME","CREATIONHOST","MODIFICATIONTIME","MODIFICATIONHOST","ATLASRELEASE","TRANSFORMATION","HOMEPACKAGE","PRODSERIESLABEL","PRODSOURCELABEL","PRODUSERID","ASSIGNEDPRIORITY","CURRENTPRIORITY","ATTEMPTNR","MAXATTEMPT","JOBSTATUS","JOBNAME","MAXCPUCOUNT","MAXCPUUNIT","MAXDISKCOUNT","MAXDISKUNIT","IPCONNECTIVITY","MINRAMCOUNT","MINRAMUNIT","STARTTIME","ENDTIME","CPUCONSUMPTIONTIME","CPUCONSUMPTIONUNIT","COMMANDTOPILOT","TRANSEXITCODE","PILOTERRORCODE","PILOTERRORDIAG","EXEERRORCODE","EXEERRORDIAG","SUPERRORCODE","SUPERRORDIAG","DDMERRORCODE","BROKERAGEERRORCODE","BROKERAGEERRORDIAG","JOBDISPATCHERERRORCODE","JOBDISPATCHERERRORDIAG","TASKBUFFERERRORCODE","TASKBUFFERERRORDIAG","COMPUTINGSITE","COMPUTINGELEMENT","JOBPARAMETERS","METADATA","PRODDBLOCK","DISPATCHDBLOCK","DESTINATIONDBLOCK","DESTINATIONSE","NEVENTS","GRID","CLOUD","CPUCONVERSION","SOURCESITE","DESTINATIONSITE","TRANSFERTYPE","TASKID","CMTCONFIG","STATECHANGETIME","PRODDBUPDATETIME","LOCKEDBY","RELOCATIONFLAG","JOBEXECUTIONID","VO","PILOTTIMING","WORKINGGROUP","PROCESSINGTYPE","PRODUSERNAME","NINPUTFILES","COUNTRYGROUP","BATCHID","PARENTID","SPECIALHANDLING","JOBSETID","CORECOUNT","NINPUTDATAFILES","INPUTFILETYPE","INPUTFILEPROJECT","INPUTFILEBYTES","NOUTPUTDATAFILES","OUTPUTFILEBYTES","JOBMETRICS","WORKQUEUE_ID","JEDITASKID","JOBSUBSTATUS","ACTUALCORECOUNT","REQID","MAXRSS","MAXVMEM","MAXSWAP","MAXPSS","AVGRSS","AVGVMEM","AVGSWAP","AVGPSS","MAXWALLTIME", "NUCLEUS", 
CASE WHEN(eventservice in (1,2,4,5) and not specialhandling like '%sc:%') THEN eventservice 
     ELSE 0 END AS ES, 0 as isarchive, eventservice
FROM DOMA_PANDA.JOBSDEFINED4 
UNION ALL

SELECT 
CAST( ORA_HASH(PANDAID, 20) as numeric) AS  PARTID,
ORA_ROWSCN AS DBMODTIME,
"PANDAID","JOBDEFINITIONID","SCHEDULERID","PILOTID","CREATIONTIME","CREATIONHOST","MODIFICATIONTIME","MODIFICATIONHOST","ATLASRELEASE","TRANSFORMATION","HOMEPACKAGE","PRODSERIESLABEL","PRODSOURCELABEL","PRODUSERID","ASSIGNEDPRIORITY","CURRENTPRIORITY","ATTEMPTNR","MAXATTEMPT","JOBSTATUS","JOBNAME","MAXCPUCOUNT","MAXCPUUNIT","MAXDISKCOUNT","MAXDISKUNIT","IPCONNECTIVITY","MINRAMCOUNT","MINRAMUNIT","STARTTIME","ENDTIME","CPUCONSUMPTIONTIME","CPUCONSUMPTIONUNIT","COMMANDTOPILOT","TRANSEXITCODE","PILOTERRORCODE","PILOTERRORDIAG","EXEERRORCODE","EXEERRORDIAG","SUPERRORCODE","SUPERRORDIAG","DDMERRORCODE","BROKERAGEERRORCODE","BROKERAGEERRORDIAG","JOBDISPATCHERERRORCODE","JOBDISPATCHERERRORDIAG","TASKBUFFERERRORCODE","TASKBUFFERERRORDIAG","COMPUTINGSITE","COMPUTINGELEMENT","JOBPARAMETERS","METADATA","PRODDBLOCK","DISPATCHDBLOCK","DESTINATIONDBLOCK","DESTINATIONSE","NEVENTS","GRID","CLOUD","CPUCONVERSION","SOURCESITE","DESTINATIONSITE","TRANSFERTYPE","TASKID","CMTCONFIG","STATECHANGETIME","PRODDBUPDATETIME","LOCKEDBY","RELOCATIONFLAG","JOBEXECUTIONID","VO","PILOTTIMING","WORKINGGROUP","PROCESSINGTYPE","PRODUSERNAME","NINPUTFILES","COUNTRYGROUP","BATCHID","PARENTID","SPECIALHANDLING","JOBSETID","CORECOUNT","NINPUTDATAFILES","INPUTFILETYPE","INPUTFILEPROJECT","INPUTFILEBYTES","NOUTPUTDATAFILES","OUTPUTFILEBYTES","JOBMETRICS","WORKQUEUE_ID","JEDITASKID","JOBSUBSTATUS","ACTUALCORECOUNT","REQID","MAXRSS","MAXVMEM","MAXSWAP","MAXPSS","AVGRSS","AVGVMEM","AVGSWAP","AVGPSS","MAXWALLTIME", "NUCLEUS", 
CASE WHEN(eventservice in (1,2,4,5) and not specialhandling like '%sc:%') THEN eventservice 
     ELSE 0 END AS ES, 0 as isarchive, eventservice
     
FROM DOMA_PANDA.JOBSWAITING4 
UNION ALL

SELECT 
CAST( ORA_HASH(PANDAID, 20) as numeric) AS  PARTID,
ORA_ROWSCN AS DBMODTIME,
"PANDAID","JOBDEFINITIONID","SCHEDULERID","PILOTID","CREATIONTIME","CREATIONHOST","MODIFICATIONTIME","MODIFICATIONHOST","ATLASRELEASE","TRANSFORMATION","HOMEPACKAGE","PRODSERIESLABEL","PRODSOURCELABEL","PRODUSERID","ASSIGNEDPRIORITY","CURRENTPRIORITY","ATTEMPTNR","MAXATTEMPT","JOBSTATUS","JOBNAME","MAXCPUCOUNT","MAXCPUUNIT","MAXDISKCOUNT","MAXDISKUNIT","IPCONNECTIVITY","MINRAMCOUNT","MINRAMUNIT","STARTTIME","ENDTIME","CPUCONSUMPTIONTIME","CPUCONSUMPTIONUNIT","COMMANDTOPILOT","TRANSEXITCODE","PILOTERRORCODE","PILOTERRORDIAG","EXEERRORCODE","EXEERRORDIAG","SUPERRORCODE","SUPERRORDIAG","DDMERRORCODE","BROKERAGEERRORCODE","BROKERAGEERRORDIAG","JOBDISPATCHERERRORCODE","JOBDISPATCHERERRORDIAG","TASKBUFFERERRORCODE","TASKBUFFERERRORDIAG","COMPUTINGSITE","COMPUTINGELEMENT","JOBPARAMETERS","METADATA","PRODDBLOCK","DISPATCHDBLOCK","DESTINATIONDBLOCK","DESTINATIONSE","NEVENTS","GRID","CLOUD","CPUCONVERSION","SOURCESITE","DESTINATIONSITE","TRANSFERTYPE","TASKID","CMTCONFIG","STATECHANGETIME","PRODDBUPDATETIME","LOCKEDBY","RELOCATIONFLAG","JOBEXECUTIONID","VO","PILOTTIMING","WORKINGGROUP","PROCESSINGTYPE","PRODUSERNAME","NINPUTFILES","COUNTRYGROUP","BATCHID","PARENTID","SPECIALHANDLING","JOBSETID","CORECOUNT","NINPUTDATAFILES","INPUTFILETYPE","INPUTFILEPROJECT","INPUTFILEBYTES","NOUTPUTDATAFILES","OUTPUTFILEBYTES","JOBMETRICS","WORKQUEUE_ID","JEDITASKID","JOBSUBSTATUS","ACTUALCORECOUNT","REQID","MAXRSS","MAXVMEM","MAXSWAP","MAXPSS","AVGRSS","AVGVMEM","AVGSWAP","AVGPSS","MAXWALLTIME", "NUCLEUS", 
CASE WHEN(eventservice in (1,2,4,5) and not specialhandling like '%sc:%') THEN eventservice 
     ELSE 0 END AS ES, 0 as isarchive, eventservice
FROM DOMA_PANDA.JOBSACTIVE4 
UNION ALL

SELECT 
CAST( ORA_HASH(PANDAID, 20) as numeric) AS  PARTID,
ORA_ROWSCN AS DBMODTIME,
"PANDAID","JOBDEFINITIONID","SCHEDULERID","PILOTID","CREATIONTIME","CREATIONHOST","MODIFICATIONTIME","MODIFICATIONHOST","ATLASRELEASE","TRANSFORMATION","HOMEPACKAGE","PRODSERIESLABEL","PRODSOURCELABEL","PRODUSERID","ASSIGNEDPRIORITY","CURRENTPRIORITY","ATTEMPTNR","MAXATTEMPT","JOBSTATUS","JOBNAME","MAXCPUCOUNT","MAXCPUUNIT","MAXDISKCOUNT","MAXDISKUNIT","IPCONNECTIVITY","MINRAMCOUNT","MINRAMUNIT","STARTTIME","ENDTIME","CPUCONSUMPTIONTIME","CPUCONSUMPTIONUNIT","COMMANDTOPILOT","TRANSEXITCODE","PILOTERRORCODE","PILOTERRORDIAG","EXEERRORCODE","EXEERRORDIAG","SUPERRORCODE","SUPERRORDIAG","DDMERRORCODE","BROKERAGEERRORCODE","BROKERAGEERRORDIAG","JOBDISPATCHERERRORCODE","JOBDISPATCHERERRORDIAG","TASKBUFFERERRORCODE","TASKBUFFERERRORDIAG","COMPUTINGSITE","COMPUTINGELEMENT","JOBPARAMETERS","METADATA","PRODDBLOCK","DISPATCHDBLOCK","DESTINATIONDBLOCK","DESTINATIONSE","NEVENTS","GRID","CLOUD","CPUCONVERSION","SOURCESITE","DESTINATIONSITE","TRANSFERTYPE","TASKID","CMTCONFIG","STATECHANGETIME","PRODDBUPDATETIME","LOCKEDBY","RELOCATIONFLAG","JOBEXECUTIONID","VO","PILOTTIMING","WORKINGGROUP","PROCESSINGTYPE","PRODUSERNAME","NINPUTFILES","COUNTRYGROUP","BATCHID","PARENTID","SPECIALHANDLING","JOBSETID","CORECOUNT","NINPUTDATAFILES","INPUTFILETYPE","INPUTFILEPROJECT","INPUTFILEBYTES","NOUTPUTDATAFILES","OUTPUTFILEBYTES","JOBMETRICS","WORKQUEUE_ID","JEDITASKID","JOBSUBSTATUS","ACTUALCORECOUNT","REQID","MAXRSS","MAXVMEM","MAXSWAP","MAXPSS","AVGRSS","AVGVMEM","AVGSWAP","AVGPSS","MAXWALLTIME", "NUCLEUS", 
CASE WHEN(eventservice in (1,2,4,5) and not specialhandling like '%sc:%') THEN eventservice 
     ELSE 0 END AS ES, 1 as isarchive, eventservice
FROM DOMA_PANDA.Jobsarchived4
)t1 LEFT JOIN DOMA_PANDA.JEDI_TASKS t2 ON t1.JEDITASKID=t2.JEDITASKID;

ALTER VIEW combined_wait_act_def_arch4 OWNER TO panda;

