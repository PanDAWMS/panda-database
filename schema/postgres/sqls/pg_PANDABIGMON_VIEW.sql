-- Generated by Ora2Pg, the Oracle database Schema converter, version 21.1
-- Copyright 2000-2020 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:PDBR

SET client_encoding TO 'UTF8';

SET search_path = doma_pandabigmon,public;
\set ON_ERROR_STOP ON

SET check_function_bodies = false;

CREATE OR REPLACE VIEW requests_view (server) AS SELECT server
   FROM doma_pandabigmon.all_requests_daily;
ALTER VIEW requests_view OWNER TO panda;

CREATE OR REPLACE VIEW geteventsfortask (jeditaskid, totevrem, totev, modificationtime) AS SELECT JEDITASKID,
ROUND(SUM(
CASE WHEN NFILESUSED > 0 THEN (NFILES-NFILESFINISHED)/NFILES*NEVENTS
     ELSE 0
END
)) as TOTEVREM, SUM(NEVENTS) as TOTEV, MAX(MODIFICATIONTIME) as MODIFICATIONTIME FROM DOMA_PANDA.JEDI_DATASETS WHERE (TYPE IN ('input','pseudo_input')) AND coalesce(MASTERID::text, '') = '' GROUP BY JEDITASKID;
ALTER VIEW geteventsfortask OWNER TO panda;

CREATE OR REPLACE VIEW combined_wait_act_def_arch4 (partid, dbmodtime, pandaid, jobdefinitionid, schedulerid, pilotid, creationtime, creationhost, modificationtime, modificationhost, atlasrelease, transformation, homepackage, prodserieslabel, prodsourcelabel, produserid, assignedpriority, currentpriority, attemptnr, maxattempt, jobstatus, jobname, maxcpucount, maxcpuunit, maxdiskcount, maxdiskunit, ipconnectivity, minramcount, minramunit, starttime, endtime, cpuconsumptiontime, cpuconsumptionunit, commandtopilot, transexitcode, piloterrorcode, piloterrordiag, exeerrorcode, exeerrordiag, superrorcode, superrordiag, ddmerrorcode, brokerageerrorcode, brokerageerrordiag, jobdispatchererrorcode, jobdispatchererrordiag, taskbuffererrorcode, taskbuffererrordiag, computingsite, computingelement, jobparameters, metadata, proddblock, dispatchdblock, destinationdblock, destinationse, nevents, grid, cloud, cpuconversion, sourcesite, destinationsite, transfertype, taskid, cmtconfig, statechangetime, proddbupdatetime, lockedby, relocationflag, jobexecutionid, vo, pilottiming, workinggroup, processingtype, produsername, ninputfiles, countrygroup, batchid, parentid, specialhandling, jobsetid, corecount, ninputdatafiles, inputfiletype, inputfileproject, inputfilebytes, noutputdatafiles, outputfilebytes, jobmetrics, workqueue_id, jeditaskid, jobsubstatus, actualcorecount, reqid, maxrss, maxvmem, maxswap, maxpss, avgrss, avgvmem, avgswap, avgpss, maxwalltime, nucleus, es, taskname, tasktype, isarchive, eventservice, username) AS SELECT PARTID, DBMODTIME , t1.PANDAID,t1.JOBDEFINITIONID,t1.SCHEDULERID,t1.PILOTID,t1.CREATIONTIME,t1.CREATIONHOST,t1.MODIFICATIONTIME,t1.MODIFICATIONHOST,t1.ATLASRELEASE,t1.TRANSFORMATION,t1.HOMEPACKAGE,t1.PRODSERIESLABEL,t1.PRODSOURCELABEL,t1.PRODUSERID,t1.ASSIGNEDPRIORITY,t1.CURRENTPRIORITY,t1.ATTEMPTNR,t1.MAXATTEMPT,t1.JOBSTATUS,t1.JOBNAME,t1.MAXCPUCOUNT,t1.MAXCPUUNIT,t1.MAXDISKCOUNT,t1.MAXDISKUNIT,t1.IPCONNECTIVITY,t1.MINRAMCOUNT,t1.MINRAMUNIT,t1.STARTTIME,t1.ENDTIME,t1.CPUCONSUMPTIONTIME,t1.CPUCONSUMPTIONUNIT,t1.COMMANDTOPILOT,t1.TRANSEXITCODE,t1.PILOTERRORCODE,t1.PILOTERRORDIAG,t1.EXEERRORCODE,t1.EXEERRORDIAG,t1.SUPERRORCODE,t1.SUPERRORDIAG,t1.DDMERRORCODE,t1.BROKERAGEERRORCODE,t1.BROKERAGEERRORDIAG,t1.JOBDISPATCHERERRORCODE,t1.JOBDISPATCHERERRORDIAG,t1.TASKBUFFERERRORCODE,t1.TASKBUFFERERRORDIAG,t1.COMPUTINGSITE,t1.COMPUTINGELEMENT,t1.JOBPARAMETERS,t1.METADATA,t1.PRODDBLOCK,t1.DISPATCHDBLOCK,t1.DESTINATIONDBLOCK,t1.DESTINATIONSE,t1.NEVENTS,t1.GRID,t1.CLOUD,t1.CPUCONVERSION,t1.SOURCESITE,t1.DESTINATIONSITE,t1.TRANSFERTYPE,t1.TASKID,t1.CMTCONFIG,t1.STATECHANGETIME,t1.PRODDBUPDATETIME,t1.LOCKEDBY,t1.RELOCATIONFLAG,t1.JOBEXECUTIONID,t1.VO,t1.PILOTTIMING,t1.WORKINGGROUP,t1.PROCESSINGTYPE,t1.PRODUSERNAME,t1.NINPUTFILES,t1.COUNTRYGROUP,t1.BATCHID,t1.PARENTID,t1.SPECIALHANDLING,t1.JOBSETID,t1.CORECOUNT,t1.NINPUTDATAFILES,t1.INPUTFILETYPE,t1.INPUTFILEPROJECT,t1.INPUTFILEBYTES,t1.NOUTPUTDATAFILES,t1.OUTPUTFILEBYTES,t1.JOBMETRICS,t1.WORKQUEUE_ID,t1.JEDITASKID,t1.JOBSUBSTATUS,t1.ACTUALCORECOUNT,t1.REQID,t1.MAXRSS,t1.MAXVMEM,t1.MAXSWAP,t1.MAXPSS,t1.AVGRSS,t1.AVGVMEM,t1.AVGSWAP,t1.AVGPSS,t1.MAXWALLTIME, t1.NUCLEUS, t1.ES, t2.TASKNAME, t2.TASKTYPE, t1.isarchive, t1.eventservice, t2.USERNAME FROM (
SELECT
0 as PARTID,
NULL as DBMODTIME,
PANDAID,JOBDEFINITIONID,SCHEDULERID,PILOTID,CREATIONTIME,CREATIONHOST,MODIFICATIONTIME,MODIFICATIONHOST,ATLASRELEASE,TRANSFORMATION,HOMEPACKAGE,PRODSERIESLABEL,PRODSOURCELABEL,PRODUSERID,ASSIGNEDPRIORITY,CURRENTPRIORITY,ATTEMPTNR,MAXATTEMPT,JOBSTATUS,JOBNAME,MAXCPUCOUNT,MAXCPUUNIT,MAXDISKCOUNT,MAXDISKUNIT,IPCONNECTIVITY,MINRAMCOUNT,MINRAMUNIT,STARTTIME,ENDTIME,CPUCONSUMPTIONTIME,CPUCONSUMPTIONUNIT,COMMANDTOPILOT,TRANSEXITCODE,PILOTERRORCODE,PILOTERRORDIAG,EXEERRORCODE,EXEERRORDIAG,SUPERRORCODE,SUPERRORDIAG,DDMERRORCODE,BROKERAGEERRORCODE,BROKERAGEERRORDIAG,JOBDISPATCHERERRORCODE,JOBDISPATCHERERRORDIAG,TASKBUFFERERRORCODE,TASKBUFFERERRORDIAG,COMPUTINGSITE,COMPUTINGELEMENT,JOBPARAMETERS,METADATA,PRODDBLOCK,DISPATCHDBLOCK,DESTINATIONDBLOCK,DESTINATIONSE,NEVENTS,GRID,CLOUD,CPUCONVERSION,SOURCESITE,DESTINATIONSITE,TRANSFERTYPE,TASKID,CMTCONFIG,STATECHANGETIME,PRODDBUPDATETIME,LOCKEDBY,RELOCATIONFLAG,JOBEXECUTIONID,VO,PILOTTIMING,WORKINGGROUP,PROCESSINGTYPE,PRODUSERNAME,NINPUTFILES,COUNTRYGROUP,BATCHID,PARENTID,SPECIALHANDLING,JOBSETID,CORECOUNT,NINPUTDATAFILES,INPUTFILETYPE,INPUTFILEPROJECT,INPUTFILEBYTES,NOUTPUTDATAFILES,OUTPUTFILEBYTES,JOBMETRICS,WORKQUEUE_ID,JEDITASKID,JOBSUBSTATUS,ACTUALCORECOUNT,REQID,MAXRSS,MAXVMEM,MAXSWAP,MAXPSS,AVGRSS,AVGVMEM,AVGSWAP,AVGPSS,MAXWALLTIME,NUCLEUS,
CASE WHEN(eventservice in (1,2,4,5) and not specialhandling like '%sc:%') THEN eventservice 
     ELSE 0 END AS ES, 0 as isarchive, eventservice
FROM DOMA_PANDA.JOBSDEFINED4
UNION ALL
SELECT
0 as PARTID,
NULL as DBMODTIME,
PANDAID,JOBDEFINITIONID,SCHEDULERID,PILOTID,CREATIONTIME,CREATIONHOST,MODIFICATIONTIME,MODIFICATIONHOST,ATLASRELEASE,TRANSFORMATION,HOMEPACKAGE,PRODSERIESLABEL,PRODSOURCELABEL,PRODUSERID,ASSIGNEDPRIORITY,CURRENTPRIORITY,ATTEMPTNR,MAXATTEMPT,JOBSTATUS,JOBNAME,MAXCPUCOUNT,MAXCPUUNIT,MAXDISKCOUNT,MAXDISKUNIT,IPCONNECTIVITY,MINRAMCOUNT,MINRAMUNIT,STARTTIME,ENDTIME,CPUCONSUMPTIONTIME,CPUCONSUMPTIONUNIT,COMMANDTOPILOT,TRANSEXITCODE,PILOTERRORCODE,PILOTERRORDIAG,EXEERRORCODE,EXEERRORDIAG,SUPERRORCODE,SUPERRORDIAG,DDMERRORCODE,BROKERAGEERRORCODE,BROKERAGEERRORDIAG,JOBDISPATCHERERRORCODE,JOBDISPATCHERERRORDIAG,TASKBUFFERERRORCODE,TASKBUFFERERRORDIAG,COMPUTINGSITE,COMPUTINGELEMENT,JOBPARAMETERS,METADATA,PRODDBLOCK,DISPATCHDBLOCK,DESTINATIONDBLOCK,DESTINATIONSE,NEVENTS,GRID,CLOUD,CPUCONVERSION,SOURCESITE,DESTINATIONSITE,TRANSFERTYPE,TASKID,CMTCONFIG,STATECHANGETIME,PRODDBUPDATETIME,LOCKEDBY,RELOCATIONFLAG,JOBEXECUTIONID,VO,PILOTTIMING,WORKINGGROUP,PROCESSINGTYPE,PRODUSERNAME,NINPUTFILES,COUNTRYGROUP,BATCHID,PARENTID,SPECIALHANDLING,JOBSETID,CORECOUNT,NINPUTDATAFILES,INPUTFILETYPE,INPUTFILEPROJECT,INPUTFILEBYTES,NOUTPUTDATAFILES,OUTPUTFILEBYTES,JOBMETRICS,WORKQUEUE_ID,JEDITASKID,JOBSUBSTATUS,ACTUALCORECOUNT,REQID,MAXRSS,MAXVMEM,MAXSWAP,MAXPSS,AVGRSS,AVGVMEM,AVGSWAP,AVGPSS,MAXWALLTIME,NUCLEUS,
CASE WHEN(eventservice in (1,2,4,5) and not specialhandling like '%sc:%') THEN eventservice 
     ELSE 0 END AS ES, 0 as isarchive, eventservice
FROM DOMA_PANDA.JOBSACTIVE4 
UNION ALL
SELECT
0 as PARTID,
NULL as DBMODTIME,
PANDAID,JOBDEFINITIONID,SCHEDULERID,PILOTID,CREATIONTIME,CREATIONHOST,MODIFICATIONTIME,MODIFICATIONHOST,ATLASRELEASE,TRANSFORMATION,HOMEPACKAGE,PRODSERIESLABEL,PRODSOURCELABEL,PRODUSERID,ASSIGNEDPRIORITY,CURRENTPRIORITY,ATTEMPTNR,MAXATTEMPT,JOBSTATUS,JOBNAME,MAXCPUCOUNT,MAXCPUUNIT,MAXDISKCOUNT,MAXDISKUNIT,IPCONNECTIVITY,MINRAMCOUNT,MINRAMUNIT,STARTTIME,ENDTIME,CPUCONSUMPTIONTIME,CPUCONSUMPTIONUNIT,COMMANDTOPILOT,TRANSEXITCODE,PILOTERRORCODE,PILOTERRORDIAG,EXEERRORCODE,EXEERRORDIAG,SUPERRORCODE,SUPERRORDIAG,DDMERRORCODE,BROKERAGEERRORCODE,BROKERAGEERRORDIAG,JOBDISPATCHERERRORCODE,JOBDISPATCHERERRORDIAG,TASKBUFFERERRORCODE,TASKBUFFERERRORDIAG,COMPUTINGSITE,COMPUTINGELEMENT,JOBPARAMETERS,METADATA,PRODDBLOCK,DISPATCHDBLOCK,DESTINATIONDBLOCK,DESTINATIONSE,NEVENTS,GRID,CLOUD,CPUCONVERSION,SOURCESITE,DESTINATIONSITE,TRANSFERTYPE,TASKID,CMTCONFIG,STATECHANGETIME,PRODDBUPDATETIME,LOCKEDBY,RELOCATIONFLAG,JOBEXECUTIONID,VO,PILOTTIMING,WORKINGGROUP,PROCESSINGTYPE,PRODUSERNAME,NINPUTFILES,COUNTRYGROUP,BATCHID,PARENTID,SPECIALHANDLING,JOBSETID,CORECOUNT,NINPUTDATAFILES,INPUTFILETYPE,INPUTFILEPROJECT,INPUTFILEBYTES,NOUTPUTDATAFILES,OUTPUTFILEBYTES,JOBMETRICS,WORKQUEUE_ID,JEDITASKID,JOBSUBSTATUS,ACTUALCORECOUNT,REQID,MAXRSS,MAXVMEM,MAXSWAP,MAXPSS,AVGRSS,AVGVMEM,AVGSWAP,AVGPSS,MAXWALLTIME,NUCLEUS,
CASE WHEN(eventservice in (1,2,4,5) and not specialhandling like '%sc:%') THEN eventservice 
     ELSE 0 END AS ES, 1 as isarchive, eventservice
FROM DOMA_PANDA.Jobsarchived4
) t1 LEFT JOIN DOMA_PANDA.JEDI_TASKS t2 ON t1.JEDITASKID=t2.JEDITASKID;
ALTER VIEW combined_wait_act_def_arch4 OWNER TO panda;

